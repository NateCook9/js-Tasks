<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>RT Tasks</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Local copies (no CDN) -->
<link rel="stylesheet" href="./lib/jspsych.css">
<script src="./lib/jspsych.js"></script>
<script src="./plugins/plugin-html-keyboard-response.js"></script>
<script src="./plugins/plugin-survey-html-form.js"></script>

<!-- Optional: silence favicon 404 -->
<link rel="icon" href="data:,">

<style>
  html, body { margin:0; height:100%; overflow:hidden; }
  #jspsych-target, #jspsych-target .jspsych-content { height:100vh; }
  #jspsych-target .jspsych-content {
    display:flex; align-items:center; justify-content:center;
    text-align:center; font-size:60px;
  }
  .typed-input { font-size:28px; padding:10px 12px; width:60vw; max-width:640px; }
  .stim { font-size:48px; margin-bottom:18px; }
  .msg { font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:#555; padding:16px; }
  .jspsych-survey-html-form .jspsych-btn { display: none !important; }
  .btn-hide { display: none !important; }
</style>
</head>
<body>
<div id="jspsych-target">Loading…</div>

<script>
(function(){
  // ---------- read URL params from Qualtrics ----------
  const q = new URLSearchParams(location.search);
  const RUN_LANG    = (q.get('run_lang') || 'EN').toUpperCase(); // EN or ES
  const LISTS       = 4; // you are using 4 lists per task
  const clamp = v => {
    const n = parseInt(v, 10);
    return Math.min(LISTS, Math.max(1, Number.isFinite(n) ? n : 1));
  };
  const LIST_LDT    = clamp(q.get('list_ldt')    || q.get('list_id') || 1);
  const LIST_SCT    = clamp(q.get('list_sct')    || q.get('list_id') || 1);
  const LIST_RECOG  = clamp(q.get('list_recog')  || q.get('list_id') || 1);
  const LIST_RECALL = clamp(q.get('list_recall') || q.get('list_id') || 1);
  const RESP_ID     = q.get('rid') || '';

  console.log({ RUN_LANG, LIST_LDT, LIST_SCT, LIST_RECOG, LIST_RECALL, RESP_ID });

  
  
  // ---------- stimuli (your arrays unchanged, except tiny typo fix noted below) ----------
  const LDT_EN = [
    [ // list 1
      { stimulus: "camory", isWord:false }, { stimulus: "enjury", isWord:false },
      { stimulus: "bank", isWord:true }, { stimulus: "incention", isWord:true },
      { stimulus: "letter", isWord:true }, { stimulus: "sentory", isWord:true },
      { stimulus: "orimal", isWord:false }, { stimulus: "woman", isWord:true },
      { stimulus: "intection", isWord:true }, { stimulus: "father", isWord:true },
      { stimulus: "polara", isWord:false }, { stimulus: "reveral", isWord:true },
      { stimulus: "child", isWord:true }, { stimulus: "vistory", isWord:true },
      { stimulus: "building", isWord:true }, { stimulus: "oritor", isWord:false },
      { stimulus: "redition", isWord:true }, { stimulus: "depeal", isWord:false },
      { stimulus: "tomicy", isWord:false }, { stimulus: "wall", isWord:true },
      { stimulus: "refective", isWord:true }, { stimulus: "avenda", isWord:false },
      { stimulus: "perily", isWord:true }, { stimulus: "dog", isWord:true },
      { stimulus: "inency", isWord:false }, { stimulus: "sendition", isWord:true },
      { stimulus: "doctor", isWord:true }, { stimulus: "indident", isWord:true },
      { stimulus: "deripe", isWord:false }, { stimulus: "street", isWord:true }
    ],
    [ // list 2
      { stimulus: "street", isWord:true }, { stimulus: "intection", isWord:true },
      { stimulus: "letter", isWord:true }, { stimulus: "orimal", isWord:false },
      { stimulus: "vistory", isWord:true }, { stimulus: "tomicy", isWord:false },
      { stimulus: "bank", isWord:true }, { stimulus: "deripe", isWord:false },
      { stimulus: "enjury", isWord:false }, { stimulus: "sentory", isWord:true },
      { stimulus: "depeal", isWord:false }, { stimulus: "reveral", isWord:true },
      { stimulus: "oritor", isWord:false }, { stimulus: "sendition", isWord:true },
      { stimulus: "woman", isWord:true }, { stimulus: "camory", isWord:false },
      { stimulus: "refective", isWord:true }, { stimulus: "dog", isWord:true },
      { stimulus: "father", isWord:true }, { stimulus: "incention", isWord:true },
      { stimulus: "polara", isWord:false }, { stimulus: "indident", isWord:true },
      { stimulus: "child", isWord:true }, { stimulus: "avenda", isWord:false },
      { stimulus: "perily", isWord:true }, { stimulus: "doctor", isWord:true },
      { stimulus: "redition", isWord:true }, { stimulus: "building", isWord:true },
      { stimulus: "inency", isWord:false }, { stimulus: "wall", isWord:true }
    ],
    [ // list 3
      { stimulus: "dog", isWord:true }, { stimulus: "tomicy", isWord:false },
      { stimulus: "perily", isWord:true }, { stimulus: "wall", isWord:true },
      { stimulus: "intection", isWord:true }, { stimulus: "orimal", isWord:false },
      { stimulus: "letter", isWord:true }, { stimulus: "sendition", isWord:true },
      { stimulus: "child", isWord:true }, { stimulus: "vistory", isWord:true },
      { stimulus: "street", isWord:true }, { stimulus: "reveral", isWord:true },
      { stimulus: "camory", isWord:false }, { stimulus: "building", isWord:true },
      { stimulus: "incention", isWord:true }, { stimulus: "enjury", isWord:false },
      { stimulus: "woman", isWord:true }, { stimulus: "redition", isWord:true },
      { stimulus: "doctor", isWord:true }, { stimulus: "oritor", isWord:false },
      { stimulus: "indident", isWord:true }, { stimulus: "inency", isWord:false },
      { stimulus: "bank", isWord:true }, { stimulus: "depeal", isWord:false },
      { stimulus: "refective", isWord:true }, { stimulus: "deripe", isWord:false },
      { stimulus: "father", isWord:true }, { stimulus: "sentory", isWord:true },
      { stimulus: "polara", isWord:false }, { stimulus: "avenda", isWord:false }
    ],
    [ // list 4
      { stimulus: "dog", isWord:true }, { stimulus: "incention", isWord:true },
      { stimulus: "father", isWord:true }, { stimulus: "enjury", isWord:false },
      { stimulus: "child", isWord:true }, { stimulus: "indident", isWord:true },
      { stimulus: "building", isWord:true }, { stimulus: "vistory", isWord:true },
      { stimulus: "doctor", isWord:true }, { stimulus: "redition", isWord:true },
      { stimulus: "oritor", isWord:false }, { stimulus: "inency", isWord:false },
      { stimulus: "refective", isWord:true }, { stimulus: "deripe", isWord:false },
      { stimulus: "tomicy", isWord:false }, { stimulus: "avenda", isWord:false },
      { stimulus: "street", isWord:true }, { stimulus: "reveral", isWord:true },
      { stimulus: "wall", isWord:true }, { stimulus: "intection", isWord:true },
      { stimulus: "woman", isWord:true }, { stimulus: "sentory", isWord:true },
      { stimulus: "depeal", isWord:false }, { stimulus: "letter", isWord:true },
      { stimulus: "orimal", isWord:false }, { stimulus: "polara", isWord:false },
      { stimulus: "sendition", isWord:true }, { stimulus: "camory", isWord:false },
      { stimulus: "perily", isWord:true }, { stimulus: "bank", isWord:true }
    ]
  ];

  const LDT_ES = [
    [ // lista 1
      { stimulus: "motilo", isWord:false }, { stimulus: "mareja", isWord:true },
      { stimulus: "carta", isWord:true }, { stimulus: "vinero", isWord:true },
      { stimulus: "mujer", isWord:true }, { stimulus: "semara", isWord:false },
      { stimulus: "banco", isWord:true }, { stimulus: "edificio", isWord:true },
      { stimulus: "verado", isWord:true }, { stimulus: "misico", isWord:false },
      { stimulus: "perro", isWord:true }, { stimulus: "tadera", isWord:true },
      { stimulus: "géneda", isWord:false }, { stimulus: "monero", isWord:false },
      { stimulus: "momido", isWord:true }, { stimulus: "médico", isWord:true },
      { stimulus: "accena", isWord:false }, { stimulus: "comana", isWord:true },
      { stimulus: "pared", isWord:true }, { stimulus: "camano", isWord:false },
      { stimulus: "cadero", isWord:true }, { stimulus: "niño", isWord:true },
      { stimulus: "caneza", isWord:true }, { stimulus: "calle", isWord:true },
      { stimulus: "madela", isWord:false }, { stimulus: "semado", isWord:true },
      { stimulus: "dinuto", isWord:false }, { stimulus: "padre", isWord:true },
      { stimulus: "motura", isWord:true }, { stimulus: "figuna", isWord:false }
    ],
    [ // lista 2
      { stimulus: "camano",   isWord:false }, { stimulus: "momido", isWord:true },
      { stimulus: "perro",  isWord:true }, { stimulus: "motura",  isWord:true },
      { stimulus: "edificio", isWord:true }, { stimulus: "vinero", isWord:true },
      { stimulus: "géneda", isWord:false }, { stimulus: "dinuto", isWord:false },
      { stimulus: "tadera", isWord:true }, { stimulus: "pared", isWord:true },
      { stimulus: "banco", isWord:true }, { stimulus: "semado", isWord:true },
      { stimulus: "padre", isWord:true }, { stimulus: "semara", isWord:false },
      { stimulus: "cadero", isWord:true }, { stimulus: "carta", isWord:true },
      { stimulus: "mujer", isWord:true }, { stimulus: "comana", isWord:true },
      { stimulus: "accena", isWord:false }, { stimulus: "verado", isWord:true },
      { stimulus: "figuna", isWord:false }, { stimulus: "monero", isWord:false },
      { stimulus: "caneza", isWord:true }, { stimulus: "madela", isWord:false },
      { stimulus: "calle", isWord:true }, { stimulus: "motilo", isWord:false },
      { stimulus: "mareja", isWord:true }, { stimulus: "médico", isWord:true },
      { stimulus: "niño", isWord:true }, { stimulus: "misico", isWord:false }
    ],
    [ // lista 3
      { stimulus: "edificio", isWord:true }, { stimulus: "géneda",  isWord:false },
      { stimulus: "momido",isWord:true }, { stimulus: "perro", isWord:true },
      { stimulus: "tadera", isWord:true }, { stimulus: "niño", isWord:true },
      { stimulus: "caneza", isWord:true }, { stimulus: "dinuto", isWord:false },
      { stimulus: "pared", isWord:true }, { stimulus: "semado", isWord:true },
      { stimulus: "padre", isWord:true }, { stimulus: "verado", isWord:true },
      { stimulus: "misico", isWord:false }, { stimulus: "camano", isWord:false },
      { stimulus: "vinero", isWord:true }, { stimulus: "monero", isWord:false },
      { stimulus: "calle", isWord:true }, { stimulus: "motilo", isWord:false },
      { stimulus: "banco", isWord:true }, { stimulus: "semara", isWord:false },
      { stimulus: "comana", isWord:true }, { stimulus: "figuna", isWord:false },
      { stimulus: "cadero", isWord:true }, { stimulus: "mujer", isWord:true },
      { stimulus: "mareja", isWord:true }, { stimulus: "accena", isWord:false },
      { stimulus: "motura", isWord:true }, { stimulus: "carta", isWord:true },
      { stimulus: "madela", isWord:false }, { stimulus: "médico", isWord:false } 
    ],
    [ // lista 4
      { stimulus: "edificio", isWord:true }, { stimulus: "perro",  isWord:true },
      { stimulus: "tadera",isWord:true }, { stimulus: "médico", isWord:true },
      { stimulus: "niño", isWord:true }, { stimulus: "momido", isWord:true },
      { stimulus: "dinuto", isWord:false }, { stimulus: "cadero", isWord:true },
      { stimulus: "carta", isWord:true }, { stimulus: "motura", isWord:true },
      { stimulus: "calle", isWord:true }, { stimulus: "camano", isWord:false },
      { stimulus: "caneza", isWord:true }, { stimulus: "padre", isWord:true },
      { stimulus: "semado", isWord:true }, { stimulus: "pared", isWord:true },
      { stimulus: "géneda", isWord:false }, { stimulus: "madela", isWord:false },
      { stimulus: "figuna", isWord:false }, { stimulus: "comana", isWord:false },
      { stimulus: "motilo", isWord:false }, { stimulus: "vinero", isWord:true },
      { stimulus: "mujer", isWord:true }, { stimulus: "verado", isWord:true },
      { stimulus: "accena", isWord:false }, { stimulus: "mareja", isWord:true },
      { stimulus: "monero", isWord:false }, { stimulus: "banco", isWord:true },
      { stimulus: "misico", isWord:false }, { stimulus: "semara", isWord:false }
    ]
  ];

  // SCT — {stimulus, isTarget}
  const SCT_EN = [
    [ {stimulus:"sentory",isTarget:false},{stimulus:"refective",isTarget:true},{stimulus:"incention",isTarget:false},{stimulus:"reveral",isTarget:true},{stimulus:"vistory",isTarget:true},{stimulus:"intection",isTarget:true},{stimulus:"perily",isTarget:false},{stimulus:"redition",isTarget:false},{stimulus:"indident",isTarget:false},{stimulus:"sendition",isTarget:true} ],
    [ {stimulus:"redition",isTarget:false},{stimulus:"vistory",isTarget:true},{stimulus:"sentory",isTarget:false},{stimulus:"perily",isTarget:false},{stimulus:"incention",isTarget:false},{stimulus:"intection",isTarget:true},{stimulus:"refective",isTarget:true},{stimulus:"indident",isTarget:false},{stimulus:"sendition",isTarget:true},{stimulus:"reveral",isTarget:true} ],
    [ {stimulus:"refective",isTarget:true},{stimulus:"redition",isTarget:false},{stimulus:"incention",isTarget:false},{stimulus:"intection",isTarget:true},{stimulus:"indident",isTarget:false},{stimulus:"sentory",isTarget:false},{stimulus:"perily",isTarget:false},{stimulus:"reveral",isTarget:true},{stimulus:"sendition",isTarget:true},{stimulus:"vistory",isTarget:true} ],
    [ {stimulus:"incention",isTarget:false},{stimulus:"reveral",isTarget:true},{stimulus:"indident",isTarget:false},{stimulus:"sendition",isTarget:true},{stimulus:"vistory",isTarget:true},{stimulus:"perily",isTarget:false},{stimulus:"intection",isTarget:true},{stimulus:"refective",isTarget:true},{stimulus:"redition",isTarget:false},{stimulus:"sentory",isTarget:false} ]
  ];
  const SCT_ES = [
    [ {stimulus:"comana",isTarget:true},{stimulus:"tadera",isTarget:false},{stimulus:"motura",isTarget:true},{stimulus:"verado",isTarget:true},{stimulus:"semado",isTarget:false},{stimulus:"mareja",isTarget:false},{stimulus:"momido",isTarget:false},{stimulus:"vinero",isTarget:true},{stimulus:"caneza",isTarget:true},{stimulus:"cadero",isTarget:false} ],
    [ {stimulus:"mareja",isTarget:false},{stimulus:"comana",isTarget:true},{stimulus:"semado",isTarget:false},{stimulus:"momido",isTarget:false},{stimulus:"verado",isTarget:true},{stimulus:"vinero",isTarget:true},{stimulus:"motura",isTarget:true},{stimulus:"tadera",isTarget:false},{stimulus:"caneza",isTarget:true},{stimulus:"cadero",isTarget:false} ],
    [ {stimulus:"momido",isTarget:false},{stimulus:"vinero",isTarget:true},{stimulus:"caneza",isTarget:true},{stimulus:"tadera",isTarget:false},{stimulus:"mareja",isTarget:false},{stimulus:"motura",isTarget:true},{stimulus:"verado",isTarget:true},{stimulus:"cadero",isTarget:false},{stimulus:"comana",isTarget:true},{stimulus:"semado",isTarget:true} ],
    [ {stimulus:"semado",isTarget:false},{stimulus:"verado",isTarget:true},{stimulus:"cadero",isTarget:false},{stimulus:"vinero",isTarget:true},{stimulus:"motura",isTarget:true},{stimulus:"mareja",isTarget:false},{stimulus:"momido",isTarget:false},{stimulus:"tadera",isTarget:false},{stimulus:"caneza",isTarget:true},{stimulus:"comana",isTarget:true} ]
  ];

  const RECOG_EN = [
    [ {prompt:"redition",  answer:"agua"}, {prompt:"reveral", answer:"mano"}, {prompt:"refective", answer:"brazo"}, {prompt:"sentory", answer:"planta"}, {prompt:"intection", answer:"cabeza"}, {prompt:"incention", answer:"mesa"}, {prompt:"perily", answer:"puerta"}, {prompt:"sendition", answer:"ojo"}, {prompt:"vistory", answer:"cuerpo"}, {prompt:"indident", answer:"libro"} ],
    [ {prompt:"perily",  answer:"puerta"}, {prompt:"vistory", answer:"cuerpo"}, {prompt:"indident", answer:"libro"}, {prompt:"reveral", answer:"mano"}, {prompt:"sentory", answer:"planta"}, {prompt:"redition", answer:"agua"}, {prompt:"sendition", answer:"ojo"}, {prompt:"intection", answer:"cabeza"}, {prompt:"refective", answer:"brazo"}, {prompt:"incention", answer:"mesa"} ],
    [ {prompt:"indident",   answer:"libro"}, {prompt:"redition",   answer:"agua"}, {prompt:"reveral", answer:"mano"}, {prompt:"vistory", answer:"cuerpo"}, {prompt:"sentory", answer:"planta"}, {prompt:"perily", answer:"puerta"}, {prompt:"incention", answer:"mesa"}, {prompt:"intection", answer:"cabeza"}, {prompt:"refective", answer:"brazo"}, {prompt:"sendition", answer:"ojo"} ],
    [ {prompt:"redition",   answer:"agua"}, {prompt:"refective",   answer:"brazo"}, {prompt:"sentory", answer:"planta"}, {prompt:"reveral", answer:"mano"}, {prompt:"indident", answer:"libro"}, {prompt:"vistory", answer:"cuerpo"}, {prompt:"perily", answer:"puerta"}, {prompt:"intection", answer:"cabeza"}, {prompt:"incention", answer:"mesa"}, {prompt:"sendition", answer:"ojo"} ]
  ];
  const RECOG_ES = [
    [ {prompt:"semado",  answer:"book"}, {prompt:"comana", answer:"head"}, {prompt:"vinero", answer:"body"}, {prompt:"motura", answer:"arm"}, {prompt:"momido", answer:"plant"}, {prompt:"mareja", answer:"water"}, {prompt:"caneza", answer:"eye"}, {prompt:"cadero", answer:"door"}, {prompt:"tadera", answer:"table"}, {prompt:"verado", answer:"hand"} ],
    [ {prompt:"cadero",  answer:"door"}, {prompt:"semado", answer:"book"}, {prompt:"caneza", answer:"eye"}, {prompt:"vinero", answer:"body"}, {prompt:"motura", answer:"arm"}, {prompt:"verado", answer:"hand"}, {prompt:"tadera", answer:"table"}, {prompt:"comana", answer:"head"}, {prompt:"momido", answer:"plant"}, {prompt:"mareja", answer:"water"} ],
    [ {prompt:"momido",  answer:"plant"}, {prompt:"mareja", answer:"water"}, {prompt:"motura", answer:"arm"}, {prompt:"vinero", answer:"body"}, {prompt:"caneza", answer:"eye"}, {prompt:"tadera", answer:"table"}, {prompt:"cadero", answer:"door"}, {prompt:"verado", answer:"hand"}, {prompt:"semado", answer:"book"}, {prompt:"comana", answer:"head"} ],
    [ {prompt:"tadera",  answer:"table"}, {prompt:"semado", answer:"book"}, {prompt:"cadero", answer:"door"}, {prompt:"caneza", answer:"eye"}, {prompt:"momido", answer:"plant"}, {prompt:"verado", answer:"hand"}, {prompt:"comana", answer:"head"}, {prompt:"motura", answer:"arm"}, {prompt:"mareja", answer:"water"}, {prompt:"vinero", answer:"body"} ]
  ];

  const RECALL_EN = [
    [ {prompt:"puerta",  answer:"perily"}, {prompt:"mano", answer:"reveral"}, {prompt:"brazo", answer:"refective"}, {prompt:"cabeza", answer:"intection"}, {prompt:"libro", answer:"indident"}, {prompt:"ojo", answer:"sendition"}, {prompt:"agua", answer:"redition"}, {prompt:"cuerpo", answer:"vistory"}, {prompt:"mesa", answer:"incention"}, {prompt:"planta", answer:"sentory"} ],
    [ {prompt:"puerta",  answer:"perily"}, {prompt:"libro", answer:"indident"}, {prompt:"planta", answer:"sentory"}, {prompt:"agua", answer:"redition"}, {prompt:"mano", answer:"reveral"}, {prompt:"cuerpo", answer:"vistory"}, {prompt:"ojo", answer:"sendition"}, {prompt:"brazo", answer:"refective"}, {prompt:"mesa", answer:"incention"}, {prompt:"cabeza", answer:"intection"} ],
    [ {prompt:"ojo",  answer:"sendition"}, {prompt:"agua", answer:"redition"}, {prompt:"mano", answer:"reveral"}, {prompt:"cuerpo", answer:"vistory"}, {prompt:"cabeza", answer:"intection"}, {prompt:"mesa", answer:"incention"}, {prompt:"puerta", answer:"perily"}, {prompt:"libro", answer:"indident"}, {prompt:"planta", answer:"sentory"}, {prompt:"brazo", answer:"refective"} ],
    [ {prompt:"mesa",  answer:"incention"}, {prompt:"puerta", answer:"perily"}, {prompt:"libro", answer:"indident"}, {prompt:"mano", answer:"reveral"}, {prompt:"cuerpo", answer:"vistory"}, {prompt:"agua", answer:"redition"}, {prompt:"ojo", answer:"sendition"}, {prompt:"brazo", answer:"refective"}, {prompt:"planta", answer:"sentory"}, {prompt:"cabeza", answer:"intection"} ]
  ];
  const RECALL_ES = [
    [ {prompt:"book",  answer:"semado"}, {prompt:"arm", answer:"motura"}, {prompt:"door", answer:"cadero"}, {prompt:"hand", answer:"verado"}, {prompt:"body", answer:"vinero"}, {prompt:"plant", answer:"momido"}, {prompt:"eye", answer:"caneza"}, {prompt:"table", answer:"tadera"}, {prompt:"head", answer:"comana"}, {prompt:"water", answer:"mareja"} ],
    [ {prompt:"hand",  answer:"verado"}, {prompt:"head", answer:"comana"}, {prompt:"arm", answer:"motura"}, {prompt:"book", answer:"semado"}, {prompt:"door", answer:"cadero"}, {prompt:"water", answer:"mareja"}, {prompt:"table", answer:"tadera"}, {prompt:"plant", answer:"momido"}, {prompt:"eye", answer:"caneza"}, {prompt:"body", answer:"vinero"} ],
    [ {prompt:"arm",  answer:"motura"}, {prompt:"table", answer:"tadera"}, {prompt:"hand", answer:"verado"}, {prompt:"eye", answer:"caneza"}, {prompt:"water", answer:"mareja"}, {prompt:"head", answer:"comana"}, {prompt:"door", answer:"cadero"}, {prompt:"body", answer:"vinero"}, {prompt:"book", answer:"semado"}, {prompt:"plant", answer:"momido"} ],
    [ {prompt:"head",  answer:"comana"}, {prompt:"book", answer:"semado"}, {prompt:"plant", answer:"momido"}, {prompt:"eye", answer:"caneza"}, {prompt:"table", answer:"tadera"}, {prompt:"door", answer:"cadero"}, {prompt:"hand", answer:"verado"}, {prompt:"body", answer:"vinero"}, {prompt:"water", answer:"mareja"}, {prompt:"arm", answer:"motura"} ]
  ];

  // ---------- practice ----------
  const PRACT_LDT_EN = [ {stimulus:"cat",isWord:true},{stimulus:"mabro",isWord:false},{stimulus:"felch",isWord:false},{stimulus:"lemon",isWord:true} ];
  const PRACT_LDT_ES = [ {stimulus:"gato",isWord:true},{stimulus:"priba",isWord:false},{stimulus:"coné",isWord:false},{stimulus:"limón",isWord:true} ];
  const PRACT_SCT_EN = [ {stimulus:"mouth",isTarget:true},{stimulus:"rat",isTarget:false},{stimulus:"button",isTarget:false},{stimulus:"leg",isTarget:true} ];
  const PRACT_SCT_ES = [ {stimulus:"boca",isTarget:true},{stimulus:"rata",isTarget:false},{stimulus:"botón",isTarget:false},{stimulus:"pierna",isTarget:true} ];
  const PRACT_RECOG_EN = [ {q:"cat",ans:"gato"},{q:"car",ans:"carro"} ];
  const PRACT_RECOG_ES = [ {q:"gato",ans:"cat"},{q:"carro",ans:"car"} ];
  const PRACT_RECALL_EN= [ {q:"gato",ans:"cat"},{q:"carro",ans:"car"} ];
  const PRACT_RECALL_ES= [ {q:"cat",ans:"gato"},{q:"car",ans:"carro"} ];

  // ---------- helpers ----------
  function showMsg(html){
    const t = document.getElementById('jspsych-target');
    t.innerHTML = `<div class="msg">${html}</div>`;
  }

  // accent/diacritic-insensitive comparison with broad browser support
  function stripDiacritics(s){
    if (!s) return "";
    const nfd = s.toString().normalize('NFD');
    // safest range for combining marks if \p{Diacritic} unsupported:
    return nfd.replace(/[\u0300-\u036f]/g, '');
  }
  function norm(s){
    return stripDiacritics(s).trim().toLowerCase();
  }

  const instr = (lang, html) => ({ type: jsPsychHtmlKeyboardResponse, stimulus:`<div style="font-size:28px;">${html}</div>`, choices:"ALL_KEYS", data:{lang, phase:"instructions"} });
  const fix   = (lang,task)=>({ type: jsPsychHtmlKeyboardResponse, stimulus:"+", choices:"NO_KEYS", trial_duration:800, data:{lang, task, phase:"fix"} });

  function blockLDT(lang, bank, label="LDT"){
    return {
      timeline: [ fix(lang,label), {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: jsPsych.timelineVariable('stimulus'),
        choices: ['f','j'],
        data: { lang, task:label, stim: jsPsych.timelineVariable('stimulus'), isWord: jsPsych.timelineVariable('isWord') },
        on_finish: d => { const corr = d.isWord ? 'j' : 'f'; d.correct = (d.response===corr); }
      } ],
      timeline_variables: bank, randomize_order:false
    };
  }
  function blockSCT(lang, bank, label="SCT"){
    return {
      timeline: [ fix(lang,label), {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: jsPsych.timelineVariable('stimulus'),
        choices: ['f','j'],
        data: { lang, task:label, stim: jsPsych.timelineVariable('stimulus'), isTarget: jsPsych.timelineVariable('isTarget') },
        on_finish: d => { const corr = d.isTarget ? 'j' : 'f'; d.correct = (d.response===corr); }
      } ],
      timeline_variables: bank, randomize_order:false
    };
  }
function blockTyped(lang, bank, label){
  return {
    timeline: [{
      type: jsPsychSurveyHtmlForm,
      html: () => {
        // Be defensive: handle if jsPsych.timelineVariable('q') yields an object
        const raw = jsPsych.timelineVariable('q');
        const promptText =
          (typeof raw === 'string') ? raw :
          (raw && typeof raw === 'object' && typeof raw.q === 'string') ? raw.q :
          String(raw ?? '');

        return `
          <div>
            <div class="stim">${promptText}</div>
            <input class="typed-input" type="text" name="resp" autocomplete="off" />
            <button class="btn-hide" type="submit" aria-hidden="true" tabindex="-1">OK</button>
          </div>`;
      },
      // keep the non-conflicting keys
      data: {
        lang,
        task: label,
        q:   jsPsych.timelineVariable('q'),
        ans: jsPsych.timelineVariable('ans')
      },
      on_load: () => {
        const i = document.querySelector('input[name=resp]');
        if (i) {
          if (document.activeElement && document.activeElement !== i) {
            try { document.activeElement.blur(); } catch(_) {}
          }
          requestAnimationFrame(() => i.focus({ preventScroll: true }));
        }
      },
      on_finish: d => {
        const r = (d.response && d.response.resp) ? d.response.resp : "";
        d.typed = r;

        // Normalize answer defensively too
        const rawAns = (typeof d.ans === 'string') ? d.ans
                    : (d.ans && typeof d.ans === 'object' && typeof d.ans.ans === 'string') ? d.ans.ans
                    : (d.ans ?? "");

        if (rawAns !== "") d.typed_correct = (norm(r) === norm(rawAns));
      }
    }],
    timeline_variables: bank,
    randomize_order: false
  };
}

  
function sanitizeTypedBank(bank){
  // Ensure each item has string prompt and keep answer as-is (can be null)
  // Map to non-conflicting keys: q (prompt), ans (answer)
  return bank.map(it => ({
    q:   (it && it.prompt != null) ? String(it.prompt) : (it && it.q != null ? String(it.q) : ""),
    ans: (it && it.answer != null) ? String(it.answer) : (it && it.ans != null ? String(it.ans) : null)
  }));
}
  
  // ---------- init ----------
  if (typeof initJsPsych !== 'function') {
    showMsg('Failed to load jsPsych. Check network/CDN access.');
    return;
  }
  const jsPsych = initJsPsych({
    display_element: 'jspsych-target',
    on_finish: function(){
      // --- build CSV ---
      const rows = jsPsych.data.get().values().map(t => {
        const lang = t.lang || RUN_LANG;
        const task = t.task || (t.phase || '');
        const stim = t.stim || t.stimulus || t.q || '';
        const rt   = (typeof t.rt==='number') ? t.rt : '';
        const resp = (typeof t.response!=='undefined') ? t.response : '';
        const typed= (typeof t.typed!=='undefined') ? t.typed : '';
        const corr = (typeof t.correct!=='undefined') ? t.correct : (typeof t.typed_correct!=='undefined' ? t.typed_correct : '');
        const isWord   = (typeof t.isWord!=='undefined')   ? t.isWord   : '';
        const isTarget = (typeof t.isTarget!=='undefined') ? t.isTarget : '';
        const answer   = (typeof t.ans!=='undefined')   ? t.ans   : '';
        return [RESP_ID, lang, task, stim, rt, typed, resp, corr, isWord, isTarget, answer].join(',');
      });
      const header = "rid,lang,task,stimulus,rt,typed,response,correct,isWord,isTarget,answer\n";
      const csv = header + rows.join("\n");

      // --- post back to Qualtrics parent ---
      try {
        window.parent.postMessage({ type:'jspsych-data', csv, lang: RUN_LANG }, '*');
      } catch(e) {
        console.warn('postMessage failed:', e);
      }

      // --- show a clear completion message when opened directly ---
      document.body.innerHTML = '<div class="msg" style="text-align:center">Task finished. You may return to the survey.</div>';
    }
  });

  // select banks per language/list with guards
  const LDT_BANK   = (RUN_LANG==='ES' ? LDT_ES : LDT_EN)[LIST_LDT-1];
  const SCT_BANK   = (RUN_LANG==='ES' ? SCT_ES : SCT_EN)[LIST_SCT-1];
  const RECOG_BANK = sanitizeTypedBank((RUN_LANG==='ES' ? RECOG_ES : RECOG_EN)[LIST_RECOG-1]);
  const RECALL_BANK= sanitizeTypedBank((RUN_LANG==='ES' ? RECALL_ES: RECALL_EN)[LIST_RECALL-1]);

console.log('BANK TYPES:', {
  LDT: Array.isArray(LDT_BANK),
  SCT: Array.isArray(SCT_BANK),
  RECOG_isArray: Array.isArray(RECOG_BANK),
  RECALL_isArray: Array.isArray(RECALL_BANK)
});
console.log('First RECOG item:', RECOG_BANK && RECOG_BANK[0]);
console.log('First RECALL item:', RECALL_BANK && RECALL_BANK[0]);

  
  if (!Array.isArray(LDT_BANK) || !Array.isArray(SCT_BANK) || !Array.isArray(RECOG_BANK) || !Array.isArray(RECALL_BANK)) {
    showMsg('Invalid list index or missing stimuli. Check URL parameters and arrays.');
    return;
  }

  const hdr = (RUN_LANG==='ES') ? "Bloque en <b>español</b>" : "Block in <b>English</b>";

  const endCard = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `<div style="font-size:28px;">
                 Thanks! You finished this task (${RUN_LANG}).<br>
                 <small>If the survey does not continue automatically, click the button below.</small><br><br>
                 <button id="fallback-finish" style="font-size:18px;padding:10px 16px;">Return to survey</button>
               </div>`,
    choices: "NO_KEYS",
    trial_duration: 1200,
    on_load: () => {
      const b = document.getElementById('fallback-finish');
      if (b) b.addEventListener('click', () => {
        window.parent.postMessage({ type:'jspsych-data', csv: null, lang: RUN_LANG }, '*');
      });
    }
  };
  
  const timeline = [
    { type: jsPsychHtmlKeyboardResponse, stimulus:`<div style="font-size:28px;">Click here and press any key to begin (${RUN_LANG}).</div>`, choices:"ALL_KEYS", data:{phase:"intro", lang:RUN_LANG, rid: RESP_ID} },

    // LDT
    instr(RUN_LANG, `${hdr}<br><br><b>Word Decision Task</b><br>Decide if each presented string of letters is a word or not.</b><br>Please treat key vocabulary words from the fill-in-the-blank reading as real words. Make this decision as quickly and as accurately as you can.</b><br>F = NOT a word, J = IS a word.<br><i>Press any key to begin practice.</i>`),
    blockLDT(RUN_LANG, (RUN_LANG==='ES' ? PRACT_LDT_ES : PRACT_LDT_EN), "LDT_practice"),
    instr(RUN_LANG, `Now the real task begins. Remember: F = NOT a word, J = IS a word. Press any key to begin.`),
    blockLDT(RUN_LANG, LDT_BANK, "LDT"),

    // SCT
    instr(RUN_LANG, `${hdr}<br><br><b>Category Judgement Task</b><br>Decide if each word's meaning belongs to the target category = BODY or BODY PART.</b><br>J = TARGET category, F = not target.<br><i>Press any key to begin practice.</i>`),
    blockSCT(RUN_LANG, (RUN_LANG==='ES' ? PRACT_SCT_ES : PRACT_SCT_EN), "SCT_practice"),
    instr(RUN_LANG, `Now the real category judgement task begins. Remember: the target category = BODY or BODY PART.</b><br>J = TARGET category, F = not target.Press any key to begin.`),
    blockSCT(RUN_LANG, SCT_BANK, "SCT"),

    // Recognition (typed)
    instr(RUN_LANG, `${hdr}<br><br><b>Vocabulary Recognition Translation</b><br>Type the translation and press Enter.<br><i>Press any key to begin practice.</i>`),
    blockTyped(RUN_LANG, (RUN_LANG==='ES' ? PRACT_RECOG_ES : PRACT_RECOG_EN), "Recognition_practice"),
    instr(RUN_LANG, `Now the real recognition block begins. Press any key.`),
    blockTyped(RUN_LANG, RECOG_BANK, "Recognition"),

    // Recall (typed)
    instr(RUN_LANG, `${hdr}<br><br><b>Vocabulary Recall Translation</b><br>Type the translation and press Enter.<br><i>Press any key to begin practice.</i>`),
    blockTyped(RUN_LANG, (RUN_LANG==='ES' ? PRACT_RECALL_ES : PRACT_RECALL_EN), "Recall_practice"),
    instr(RUN_LANG, `Now the real recall block begins. Press any key.`),
    blockTyped(RUN_LANG, RECALL_BANK, "Recall"),

    endCard
  ];

  jsPsych.run(timeline);
})();
</script>
</body>
</html>
